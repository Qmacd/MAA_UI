<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¤šæ™ºèƒ½ä½“å¯¹æŠ—è®­ç»ƒå¹³å°</title>
  <style>
    :root {
      --primary-color: #1e3c72;
      --secondary-color: #2a5298;
      --accent-color: #3498db;
      --success-color: #2ecc71;
      --text-color: #2c3e50;
      --bg-color: #f5f6fa;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-color);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 20px;
      margin: -20px -20px 20px -20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .header-left {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .header-right {
      text-align: right;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 32px;
      font-weight: bold;
      margin: 0;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .color-word {
      display: flex;
      gap: 2px;
      font-size: 36px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .char-q { color: #FFD700; animation: glow 2s infinite; }
    .char-m { color: #4169E1; animation: glow 2s infinite 0.4s; }
    .char-a { color: #FFD700; animation: glow 2s infinite 1.2s; }
    .char-c { color: #FF4500; animation: glow 2s infinite 1.6s; }
    .char-d { color: #FF4500; animation: glow 2s infinite 0.8s; }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
      50% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      width: 100%;
    }

    .parameter-section {
      background: var(--card-bg);
      margin: 20px 0;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    .parameter-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .parameter-section h2 {
      font-size: 22px;
      font-weight: bold;
      margin: 0 0 20px 0;
      color: var(--text-color);
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      position: relative;
    }

    .parameter-section h2::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 50px;
      height: 2px;
      background: var(--accent-color);
      transition: width 0.3s ease;
    }

    .parameter-section:hover h2::after {
      width: 100px;
    }

    label {
      display: block;
      margin: 15px 0 5px;
      font-size: 16px;
      color: var(--text-color);
      font-weight: 500;
    }

    input[type="text"], 
    input[type="number"],
    select {
      width: 100%;
      max-width: 500px;
      padding: 12px 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin: 5px 0;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    input[type="text"]:focus, 
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
      background: white;
    }

    button {
      padding: 12px 24px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-color) 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52,152,219,0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .start-button {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2980b9 100%);
      font-size: 18px;
      padding: 15px 30px;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
    }

    .start-button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      animation: buttonShine 3s infinite;
    }

    @keyframes buttonShine {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(100%) rotate(45deg); }
    }

    #logOutput {
      height: 300px;
      overflow-y: scroll;
      border: 2px solid #e0e0e0;
      padding: 20px;
      white-space: pre-wrap;
      background-color: #1e1e1e;
      color: #00ff00;
      font-size: 14px;
      font-family: 'Consolas', 'Monaco', monospace;
      border-radius: 8px;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      border: 2px solid #e0e0e0;
      padding: 25px;
      border-radius: 10px;
      background-color: #f8f9fa;
      margin: 15px 0;
      transition: all 0.3s ease;
    }

    .checkbox-grid:hover {
      border-color: var(--accent-color);
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .checkbox-grid label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      margin: 0;
      padding: 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .checkbox-grid label:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .checkbox-grid input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-actions {
      margin: 20px 0;
      display: flex;
      gap: 15px;
    }

    .selection-count {
      margin-left: 15px;
      color: #6c757d;
      font-size: 14px;
      font-weight: 500;
    }

    /* æ·»åŠ å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .parameter-section {
        padding: 15px;
      }
      
      .checkbox-grid {
        grid-template-columns: 1fr;
      }
    }

    /* æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2980b9;
    }

    .visualization-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }

    .visualization-section h3 {
      margin: 0 0 15px 0;
      color: var(--text-color);
      font-size: 18px;
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 10px;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 15px;
      align-items: stretch;
    }

    .image-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .image-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .image-container h4 {
      margin: 0 0 10px 0;
      color: var(--text-color);
      font-size: 16px;
      text-align: center;
    }

    .image-container img {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: contain;
      border-radius: 4px;
      transition: transform 0.3s ease;
      flex: 1;
    }

    .image-container img:hover {
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .image-grid {
        grid-template-columns: 1fr;
      }
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin: 15px 0;
      box-sizing: border-box;
    }

    .prediction-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 600px;
      table-layout: fixed;
    }

    .prediction-table th,
    .prediction-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .prediction-table th {
      background: var(--accent-color);
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .prediction-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .prediction-table tr:hover {
      background-color: #f1f3f5;
    }

    .prediction-table td {
      color: var(--text-color);
    }

    .prediction-table .positive {
      color: #2ecc71;
    }

    .prediction-table .negative {
      color: #e74c3c;
    }

    #predictionResultsContent {
      width: 100%;
      box-sizing: border-box;
    }

    .custom-model-section {
      margin-top: 30px;
      padding: 25px;
      background: #ffffff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .custom-model-section h3 {
      margin: 0 0 15px 0;
      color: var(--text-color);
      font-size: 20px;
      font-weight: 600;
    }

    .section-description {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
      line-height: 1.5;
    }

    .model-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }

    .model-upload-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .model-upload-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .model-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .model-header h4 {
      margin: 0;
      font-size: 16px;
      color: var(--text-color);
      font-weight: 600;
    }

    .model-type-selector {
      display: flex;
      gap: 15px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .radio-label:hover {
      background: rgba(52,152,219,0.1);
    }

    .radio-text {
      font-size: 14px;
      color: #666;
    }

    .file-upload-area {
      position: relative;
      margin-bottom: 15px;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .file-upload-area.has-file {
      border-color: var(--accent-color);
      background: rgba(52,152,219,0.05);
    }

    .file-info {
      display: none;
      margin-top: 10px;
      padding: 8px 12px;
      background: #e8f4fd;
      border-radius: 6px;
      font-size: 14px;
      color: #2c3e50;
    }

    .file-info.show {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .file-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-icon {
      font-size: 18px;
    }

    .remove-file {
      cursor: pointer;
      color: #e74c3c;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .remove-file:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    .model-file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .upload-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .upload-icon {
      font-size: 24px;
      color: #666;
    }

    .model-description {
      width: 100%;
      box-sizing: border-box;
      margin-top: 15px;
    }

    .model-description textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      resize: vertical;
      font-size: 14px;
      line-height: 1.5;
      transition: all 0.3s ease;
      box-sizing: border-box;
      background-color: #f8f9fa;
    }

    .model-description textarea:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
      outline: none;
    }

    .model-structure-info {
      margin-top: 10px;
      padding: 10px;
      background: #e8f4fd;
      border-radius: 6px;
      font-size: 14px;
      color: #2c3e50;
      display: none;
    }

    .model-structure-info.show {
      display: block;
    }

    .structure-loading {
      display: none;
      text-align: center;
      padding: 10px;
      color: #666;
    }

    .structure-loading.show {
      display: block;
    }

    .model-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .model-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
      outline: none;
    }

    .model-upload-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .upload-button, .reset-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .upload-button {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2980b9 100%);
      color: white;
    }

    .reset-button {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
    }

    .button-icon {
      font-size: 18px;
    }

    .upload-button:hover, .reset-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @media (max-width: 768px) {
      .model-upload-grid {
        grid-template-columns: 1fr;
      }
      
      .model-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .model-type-selector {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>å¤šæ™ºèƒ½ä½“å¯¹æŠ—è®­ç»ƒå¹³å°</h1>
    </div>
    <div class="header-right">
      <div class="logo">
        <div class="logo-text">MAA</div>
        <div class="color-word">
          <span class="char-q">Q</span>
          <span class="char-m">m</span>
          <span class="char-a">a</span>
          <span class="char-c">c</span>
          <span class="char-d">d</span>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ GitHubä¿¡æ¯ -->
  <div class="github-info" style="background: #f8f9fa; padding: 15px; margin: 0 -20px 20px -20px; border-bottom: 1px solid #dee2e6;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
      <div class="project-info">
        <h3 style="margin: 0; color: #2c3e50;">MAA (Multi-GAN Adversarial Analysis)</h3>
        <p style="margin: 5px 0 0 0; color: #666;">åŸºäºå¯¹æŠ—å­¦ä¹ æ€æƒ³çš„äººå·¥æ™ºèƒ½æ¨¡å‹è®­ç»ƒç³»ç»Ÿ-æ—¶åºé¢„æµ‹åˆ†æ”¯</p>
      </div>
      <div class="github-links">
        <a href="https://github.com/Qmacd/MAA_UI" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: #2c3e50; padding: 8px 15px; border-radius: 5px; background: #fff; border: 1px solid #dee2e6; transition: all 0.3s ease;">
          <svg height="20" width="20" viewBox="0 0 16 16" style="margin-right: 8px;">
            <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          GitHub ä»“åº“
        </a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- åŸºæœ¬å‚æ•°è®¾ç½® -->
    <div class="parameter-section">
      <h2>åŸºæœ¬å‚æ•°è®¾ç½®</h2>
      
      <label for="data_path">æ•°æ®æ–‡ä»¶è·¯å¾„:</label>
      <input type="text" id="data_path" value="{{ data_path }}" placeholder="ä¾‹å¦‚: database/zx_processed_é»„é‡‘_day.csv">
      <button onclick="loadColumns()">åŠ è½½åˆ—å</button>
      
      <label for="output_dir">è¾“å‡ºç›®å½•:</label>
      <input type="text" id="output_dir" value="{{ output_dir }}" placeholder="ä¾‹å¦‚: out_put/multi">
      
      <label for="ckpt_dir">æ£€æŸ¥ç‚¹ç›®å½•:</label>
      <input type="text" id="ckpt_dir" value="{{ ckpt_dir }}" placeholder="ä¾‹å¦‚: out_put/ckpt">
    </div>

    <!-- è®­ç»ƒå‚æ•°è®¾ç½® -->
    <div class="parameter-section">
      <h2>è®­ç»ƒå‚æ•°è®¾ç½®</h2>
      
      <label for="batch_size">æ‰¹æ¬¡å¤§å°:</label>
      <input type="number" id="batch_size" value="{{ batch_size }}" min="1">
      
      <label for="num_epochs">è®­ç»ƒè½®æ•°:</label>
      <input type="number" id="num_epochs" value="{{ num_epochs }}" min="1">
      
      <label for="lr">å­¦ä¹ ç‡:</label>
      <input type="number" id="lr" value="{{ lr }}" step="0.000001">
      
      <label for="train_split">è®­ç»ƒé›†æ¯”ä¾‹:</label>
      <input type="number" id="train_split" value="{{ train_split }}" min="0" max="1" step="0.1">
      
      <label for="window_sizes">çª—å£å¤§å° (ç”¨é€—å·åˆ†éš”):</label>
      <input type="text" id="window_sizes" value="{{ window_sizes|join(',') }}" placeholder="ä¾‹å¦‚: 5,10,15">

      <!-- æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹ä¸Šä¼ åŒºåŸŸ -->
      <div class="custom-model-section">
        <h3>æ¨¡å‹é…ç½®</h3>
        <p class="section-description">è¯·ä¸ºæ¯ä¸ªä½ç½®é…ç½®ä¸€ä¸ªæ¨¡å‹ï¼ˆè‡ªå®šä¹‰æˆ–ç³»ç»Ÿé¢„è®¾ï¼‰ã€‚ç³»ç»Ÿéœ€è¦3ä¸ªæ¨¡å‹è¿›è¡Œå¯¹æŠ—è®­ç»ƒã€‚</p>
        
        <!-- æ·»åŠ æ ¼å¼è¯´æ˜ -->
        <div class="format-guide" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #dee2e6;">
          <h4 style="margin-top: 0; color: #2c3e50;">è‡ªå®šä¹‰æ¨¡å‹æ ¼å¼è¯´æ˜ï¼š</h4>
          <p style="margin-bottom: 10px;">ä¸Šä¼ çš„æ¨¡å‹æ–‡ä»¶éœ€è¦æ˜¯ä¸€ä¸ªPythonç±»ï¼Œç»§æ‰¿è‡ªtorch.nn.Moduleï¼Œå¹¶åŒ…å«ä»¥ä¸‹åŸºæœ¬ç»“æ„ï¼š</p>
          <pre style="background: #2c3e50; color: #fff; padding: 15px; border-radius: 5px; overflow-x: auto;">
class CustomModel(nn.Module):
    def __init__(self, input_dim, hidden_dim, output_dim):
        super().__init__()
        self.input_dim = input_dim
        self.hidden_dim = hidden_dim
        self.output_dim = output_dim
        
        # å®šä¹‰ç½‘ç»œå±‚
        self.layer1 = nn.Linear(input_dim, hidden_dim)
        self.layer2 = nn.Linear(hidden_dim, output_dim)
        
    def forward(self, x):
        # x shape: [batch_size, sequence_length, input_dim]
        x = self.layer1(x)
        x = torch.relu(x)
        x = self.layer2(x)
        return x</pre>
          <p style="margin-top: 10px; color: #666;">æ³¨æ„äº‹é¡¹ï¼š</p>
          <ul style="color: #666; margin-top: 5px;">
            <li>æ¨¡å‹å¿…é¡»ç»§æ‰¿è‡ªtorch.nn.Module</li>
            <li>å¿…é¡»åŒ…å«__init__å’Œforwardæ–¹æ³•</li>
            <li>forwardæ–¹æ³•çš„è¾“å…¥xå½¢çŠ¶ä¸º[batch_size, sequence_length, input_dim]</li>
            <li>è¾“å‡ºå½¢çŠ¶åº”ä¸º[batch_size, sequence_length, output_dim]</li>
            <li>å»ºè®®ä½¿ç”¨PyTorchå†…ç½®çš„å±‚ï¼ˆå¦‚nn.Linear, nn.LSTMç­‰ï¼‰</li>
          </ul>
        </div>
        
        <div class="model-upload-grid">
          <!-- æ¨¡å‹1ä¸Šä¼ åŒºåŸŸ -->
          <div class="model-upload-item">
            <div class="model-header">
              <h4>æ¨¡å‹ 1</h4>
              <div class="model-type-selector">
                <label class="radio-label">
                  <input type="radio" name="model1Type" value="custom" checked onchange="toggleModelType(1)">
                  <span class="radio-text">è‡ªå®šä¹‰æ¨¡å‹</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="model1Type" value="preset" onchange="toggleModelType(1)">
                  <span class="radio-text">ç³»ç»Ÿé¢„è®¾</span>
                </label>
              </div>
            </div>
            <div class="custom-model-upload" id="model1Upload">
              <div class="file-upload-area">
                <input type="file" id="customModel1" accept=".py" class="model-file-input">
                <div class="upload-placeholder">
                  <i class="upload-icon">ğŸ“</i>
                  <span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ¨¡å‹æ–‡ä»¶</span>
                </div>
              </div>
            </div>
            <div class="preset-model-select" id="model1Preset" style="display: none;">
              <select id="presetModel1" class="model-select">
                <option value="gru">GRU</option>
                <option value="lstm">LSTM</option>
                <option value="transformer">Transformer</option>
              </select>
            </div>
          </div>

          <!-- æ¨¡å‹2ä¸Šä¼ åŒºåŸŸ -->
          <div class="model-upload-item">
            <div class="model-header">
              <h4>æ¨¡å‹ 2</h4>
              <div class="model-type-selector">
                <label class="radio-label">
                  <input type="radio" name="model2Type" value="custom" checked onchange="toggleModelType(2)">
                  <span class="radio-text">è‡ªå®šä¹‰æ¨¡å‹</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="model2Type" value="preset" onchange="toggleModelType(2)">
                  <span class="radio-text">ç³»ç»Ÿé¢„è®¾</span>
                </label>
              </div>
            </div>
            <div class="custom-model-upload" id="model2Upload">
              <div class="file-upload-area">
                <input type="file" id="customModel2" accept=".py" class="model-file-input">
                <div class="upload-placeholder">
                  <i class="upload-icon">ğŸ“</i>
                  <span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ¨¡å‹æ–‡ä»¶</span>
                </div>
              </div>
            </div>
            <div class="preset-model-select" id="model2Preset" style="display: none;">
              <select id="presetModel2" class="model-select">
                <option value="gru">GRU</option>
                <option value="lstm">LSTM</option>
                <option value="transformer">Transformer</option>
              </select>
            </div>
          </div>

          <!-- æ¨¡å‹3ä¸Šä¼ åŒºåŸŸ -->
          <div class="model-upload-item">
            <div class="model-header">
              <h4>æ¨¡å‹ 3</h4>
              <div class="model-type-selector">
                <label class="radio-label">
                  <input type="radio" name="model3Type" value="custom" checked onchange="toggleModelType(3)">
                  <span class="radio-text">è‡ªå®šä¹‰æ¨¡å‹</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="model3Type" value="preset" onchange="toggleModelType(3)">
                  <span class="radio-text">ç³»ç»Ÿé¢„è®¾</span>
                </label>
              </div>
            </div>
            <div class="custom-model-upload" id="model3Upload">
              <div class="file-upload-area">
                <input type="file" id="customModel3" accept=".py" class="model-file-input">
                <div class="upload-placeholder">
                  <i class="upload-icon">ğŸ“</i>
                  <span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ¨¡å‹æ–‡ä»¶</span>
                </div>
              </div>
            </div>
            <div class="preset-model-select" id="model3Preset" style="display: none;">
              <select id="presetModel3" class="model-select">
                <option value="gru">GRU</option>
                <option value="lstm">LSTM</option>
                <option value="transformer">Transformer</option>
              </select>
            </div>
          </div>
        </div>

        <div class="model-upload-actions">
          <button onclick="uploadCustomModels()" class="upload-button">
            <i class="button-icon">ğŸ“¤</i>
            ä¸Šä¼ æ¨¡å‹
          </button>
          <button onclick="resetCustomModels()" class="reset-button">
            <i class="button-icon">ğŸ”„</i>
            é‡ç½®
          </button>
        </div>
      </div>
    </div>

    <!-- ç‰¹å¾å’Œç›®æ ‡åˆ—é€‰æ‹© -->
    <div class="parameter-section" id="columnSelectionSection" style="display: none;">
      <h2>ç‰¹å¾å’Œç›®æ ‡åˆ—é€‰æ‹©</h2>
      <div id="loadingMessage">æ­£åœ¨åŠ è½½åˆ—åï¼Œè¯·ç¨å€™...</div>
      <div id="columnSelectionContent" style="display: none;">
        <div id="ganGroups">
          <div class="gan-group">
            <h3>GAN 1 ç‰¹å¾é€‰æ‹©</h3>
            <div class="checkbox-grid" id="feature1Select"></div>
            <div class="checkbox-actions">
              <button onclick="selectAll('feature1')">å…¨é€‰</button>
              <button onclick="clearAll('feature1')">æ¸…é™¤</button>
            </div>
          </div>
          
          <div class="gan-group">
            <h3>GAN 2 ç‰¹å¾é€‰æ‹©</h3>
            <div class="checkbox-grid" id="feature2Select"></div>
            <div class="checkbox-actions">
              <button onclick="selectAll('feature2')">å…¨é€‰</button>
              <button onclick="clearAll('feature2')">æ¸…é™¤</button>
            </div>
          </div>
          
          <div class="gan-group">
            <h3>GAN 3 ç‰¹å¾é€‰æ‹©</h3>
            <div class="checkbox-grid" id="feature3Select"></div>
            <div class="checkbox-actions">
              <button onclick="selectAll('feature3')">å…¨é€‰</button>
              <button onclick="clearAll('feature3')">æ¸…é™¤</button>
            </div>
          </div>
        </div>

        <label>é€‰æ‹©ç›®æ ‡åˆ—:</label>
        <div class="checkbox-grid" id="targetSelect"></div>
        <div class="checkbox-actions">
          <button onclick="selectAll('target')">å…¨é€‰</button>
          <button onclick="clearAll('target')">æ¸…é™¤</button>
        </div>
      </div>
    </div>

    <button onclick="startTraining()" class="start-button" id="startTrainingButton" style="display: none;">å¼€å§‹è®­ç»ƒæ¨¡å‹</button>

    <!-- é¢„æµ‹éƒ¨åˆ† -->
    <div class="parameter-section">
      <h2>é¢„æµ‹è®¾ç½®</h2>
      <label for="predict_input">é¢„æµ‹è¾“å…¥æ•°æ®è·¯å¾„:</label>
      <input type="text" id="predict_input" placeholder="ä¾‹å¦‚: database/test_data.csv">

      <label for="predict_output">é¢„æµ‹ç»“æœè¾“å‡ºè·¯å¾„:</label>
      <input type="text" id="predict_output" placeholder="ä¾‹å¦‚: out_put/predictions.csv">

      <label for="predict_ckpt">æ¨¡å‹æ£€æŸ¥ç‚¹è·¯å¾„:</label>
      <input type="text" id="predict_ckpt" value="out_put/ckpt" placeholder="ä¾‹å¦‚: out_put/ckpt">

      <button onclick="startPrediction()" class="start-button">å¼€å§‹é¢„æµ‹</button>
    </div>

    <!-- é¢„æµ‹ç»“æœå±•ç¤º -->
    <div class="parameter-section" id="predictionResults" style="display: none;">
      <h2>é¢„æµ‹ç»“æœ</h2>
      <div id="predictionResultsContent">
        <!-- é¢„æµ‹ç»“æœè¡¨æ ¼ -->
        <div class="visualization-section">
          <h3>é¢„æµ‹ç»“æœæ•°æ®</h3>
          <div class="table-container">
            <table id="predictionTable" class="prediction-table">
              <thead>
                <tr>
                  <th>åŠ è½½ä¸­...</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>

        <!-- æ‹Ÿåˆæ›²çº¿ -->
        <div class="visualization-section">
          <h3>æ‹Ÿåˆæ›²çº¿</h3>
          <div class="image-grid">
            <div class="image-container">
              <h4>G1è®­ç»ƒé›†æ‹Ÿåˆ</h4>
              <img id="g1TrainFitting" src="" alt="G1è®­ç»ƒé›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
            <div class="image-container">
              <h4>G1æµ‹è¯•é›†æ‹Ÿåˆ</h4>
              <img id="g1TestFitting" src="" alt="G1æµ‹è¯•é›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
            <div class="image-container">
              <h4>G2è®­ç»ƒé›†æ‹Ÿåˆ</h4>
              <img id="g2TrainFitting" src="" alt="G2è®­ç»ƒé›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
            <div class="image-container">
              <h4>G2æµ‹è¯•é›†æ‹Ÿåˆ</h4>
              <img id="g2TestFitting" src="" alt="G2æµ‹è¯•é›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
            <div class="image-container">
              <h4>G3è®­ç»ƒé›†æ‹Ÿåˆ</h4>
              <img id="g3TrainFitting" src="" alt="G3è®­ç»ƒé›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
            <div class="image-container">
              <h4>G3æµ‹è¯•é›†æ‹Ÿåˆ</h4>
              <img id="g3TestFitting" src="" alt="G3æµ‹è¯•é›†æ‹Ÿåˆæ›²çº¿" style="display: none;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—è¾“å‡º -->
    <div class="parameter-section">
      <h2>è¿è¡Œæ—¥å¿—è¾“å‡º</h2>
      <pre id="logOutput">ç­‰å¾…æ—¥å¿—è¾“å‡º...</pre>
    </div>
  </div>

  <script>
    function loadColumns() {
      const path = document.getElementById('data_path').value;
      if (!path) {
        alert('è¯·è¾“å…¥æ•°æ®æ–‡ä»¶è·¯å¾„');
        return;
      }

      // æ˜¾ç¤ºåˆ—é€‰æ‹©åŒºåŸŸå’ŒåŠ è½½æ¶ˆæ¯
      const columnSelectionSection = document.getElementById('columnSelectionSection');
      const loadingMessage = document.getElementById('loadingMessage');
      const columnSelectionContent = document.getElementById('columnSelectionContent');
      
      // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å…ƒç´ éƒ½å­˜åœ¨
      if (!columnSelectionSection || !loadingMessage || !columnSelectionContent) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
        return;
      }

      columnSelectionSection.style.display = 'block';
      loadingMessage.style.display = 'block';
      columnSelectionContent.style.display = 'none';
      
      const startTrainingButton = document.getElementById('startTrainingButton');
      if (startTrainingButton) {
        startTrainingButton.style.display = 'none';
      }

      fetch('/columns?path=' + encodeURIComponent(path))
        .then(response => response.json())
        .then(data => {
          if (data.columns && data.columns.length > 0) {
            // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©åŒºåŸŸ
            const selectors = ['feature1Select', 'feature2Select', 'feature3Select', 'targetSelect'];
            selectors.forEach(id => {
              const element = document.getElementById(id);
              if (element) {
                element.innerHTML = '';
              }
            });

            data.columns.forEach(col => {
              // ä¸ºæ¯ä¸ªGANç»„åˆ›å»ºç‰¹å¾åˆ—å¤é€‰æ¡†
              for (let i = 1; i <= 3; i++) {
                const selectElement = document.getElementById('feature' + i + 'Select');
                if (selectElement) {
                  const item = createCheckboxItem(col);
                  const checkbox = item.querySelector('input');
                  if (checkbox) {
                    checkbox.addEventListener('change', () => {
                      updateSelectedCount('feature' + i);
                    });
                  }
                  selectElement.appendChild(item);
                }
              }

              // åˆ›å»ºç›®æ ‡åˆ—å¤é€‰æ¡†
              const targetSelect = document.getElementById('targetSelect');
              if (targetSelect) {
                const targetItem = createCheckboxItem(col);
                const checkbox = targetItem.querySelector('input');
                if (checkbox) {
                  checkbox.addEventListener('change', () => {
                    updateSelectedCount('target');
                  });
                }
                targetSelect.appendChild(targetItem);
              }
            });

            // æ›´æ–°æ‰€æœ‰é€‰æ‹©è®¡æ•°
            ['feature1', 'feature2', 'feature3', 'target'].forEach(type => {
              updateSelectedCount(type);
            });

            // æ˜¾ç¤ºåˆ—é€‰æ‹©å†…å®¹å’Œå¼€å§‹è®­ç»ƒæŒ‰é’®
            loadingMessage.style.display = 'none';
            columnSelectionContent.style.display = 'block';
            if (startTrainingButton) {
              startTrainingButton.style.display = 'block';
            }
          } else if (data.error) {
            loadingMessage.innerHTML = `<p style="color: red;">åŠ è½½åˆ—åå¤±è´¥: ${data.error}</p>`;
          } else {
            loadingMessage.innerHTML = '<p style="color: red;">åˆ—ååŠ è½½å¤±è´¥: æ•°æ®æ ¼å¼é”™è¯¯</p>';
          }
        })
        .catch(error => {
          loadingMessage.innerHTML = `<p style="color: red;">è¯·æ±‚åˆ—åå¤±è´¥: ${error.message}</p>`;
        });
    }

    // åˆ›å»ºå¸¦å¤é€‰æ¡†çš„åˆ—é¡¹
    function createCheckboxItem(col) {
      const container = document.createElement('label');
      container.className = 'checkbox-item';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = col.name;
      checkbox.value = `åˆ—[${col.index}]: ${col.name}`;
      container.appendChild(checkbox);
      container.appendChild(document.createTextNode(`åˆ—[${col.index}]: ${col.name}`));
      return container;
    }

    // è·å–æ‰€æœ‰é€‰ä¸­çš„å€¼
    function getSelectedValues(containerId) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ : ${containerId}`);
        return [];
      }
      const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // å…¨é€‰
    function selectAll(type) {
      console.log('Selecting all for:', type);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      const container = document.getElementById(type + "Select");
      if (!container) {
        console.error(`æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ : ${type}Select`);
        return;
      }
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      console.log('Found checkboxes:', checkboxes.length);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      checkboxes.forEach(cb => {
        cb.checked = true;
        // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°è®¡æ•°
        cb.dispatchEvent(new Event('change'));
      });
    }

    // æ¸…é™¤
    function clearAll(type) {
      console.log('Clearing all for:', type);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      const container = document.getElementById(type + "Select");
      if (!container) {
        console.error(`æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ : ${type}Select`);
        return;
      }
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      console.log('Found checkboxes:', checkboxes.length);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      checkboxes.forEach(cb => {
        cb.checked = false;
        // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°è®¡æ•°
        cb.dispatchEvent(new Event('change'));
      });
    }

    // æ˜¾ç¤ºå·²é€‰æ•°é‡
    function updateSelectedCount(type) {
      console.log('Updating count for:', type);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      const container = document.getElementById(type + "Select");
      if (!container) {
        console.error(`æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ : ${type}Select`);
        return;
      }
      const count = container.querySelectorAll('input[type="checkbox"]:checked').length;
      console.log('Selected count:', count);  // æ·»åŠ è°ƒè¯•æ—¥å¿—
      const actionDiv = container.nextElementSibling;
      if (actionDiv && actionDiv.classList.contains('checkbox-actions')) {
        const status = document.createElement('span');
        status.className = 'selection-count';
        status.textContent = `å·²é€‰: ${count}`;
        // ç§»é™¤æ—§çš„çŠ¶æ€æç¤º
        const old = actionDiv.querySelector('.selection-count');
        if (old) old.remove();
        actionDiv.appendChild(status);
      }
    }

    async function startTraining() {
      const dataPath = document.getElementById('data_path').value;
      const ckptDir = document.getElementById('ckpt_dir').value;
      
      // è·å–ä¸‰ä¸ªGANç»„çš„ç‰¹å¾åˆ—
      const featureColumns1 = getSelectedValues('feature1Select');
      const featureColumns2 = getSelectedValues('feature2Select');
      const featureColumns3 = getSelectedValues('feature3Select');
      const targetColumns = getSelectedValues('targetSelect');
      
      const batchSize = document.getElementById('batch_size').value;
      const numEpochs = document.getElementById('num_epochs').value;
      const lr = document.getElementById('lr').value;
      const trainSplit = document.getElementById('train_split').value;
      const windowSizesInput = document.getElementById('window_sizes').value;
      const windowSizes = windowSizesInput.split(',').map(size => parseInt(size.trim())).filter(size => !isNaN(size));

      // æ£€æŸ¥å¿…è¦å‚æ•°
      if (!dataPath || !ckptDir || 
          featureColumns1.length === 0 || 
          featureColumns2.length === 0 || 
          featureColumns3.length === 0 || 
          targetColumns.length === 0 ||
          windowSizes.length === 0) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦å‚æ•°å¹¶ä¸ºæ¯ä¸ªGANé€‰æ‹©ç‰¹å¾åˆ—ï¼');
        return;
      }

      // è·å–æ¨¡å‹é…ç½®
      const modelConfig = {
        models: []
      };

      // æ£€æŸ¥æ¯ä¸ªæ¨¡å‹ä½ç½®
      for (let i = 1; i <= 3; i++) {
        const modelType = document.querySelector(`input[name="model${i}Type"]:checked`).value;
        const modelInfo = {
          type: modelType,
          index: i
        };

        if (modelType === 'custom') {
          const modelFile = document.getElementById(`customModel${i}`).files[0];
          
          if (!modelFile) {
            alert(`è¯·ä¸ºæ¨¡å‹ ${i} ä¸Šä¼ æ–‡ä»¶ï¼`);
            return;
          }
          
          modelInfo.file = modelFile;
        } else {
          const presetModel = document.getElementById(`presetModel${i}`).value;
          modelInfo.preset = presetModel;
        }
        
        modelConfig.models.push(modelInfo);
      }

      // æ‰“å°æ¨¡å‹é…ç½®ç”¨äºè°ƒè¯•
      console.log('æ¨¡å‹é…ç½®:', modelConfig);

      // ç¦ç”¨å¼€å§‹æŒ‰é’®
      const startButton = document.querySelector('.start-button');
      startButton.disabled = true;
      startButton.textContent = 'è®­ç»ƒä¸­...';

      try {
        // å…ˆæ¸…ç©ºæ—¥å¿—è¾“å‡º
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent = 'æ­£åœ¨å¯åŠ¨è®­ç»ƒ...\n';
        
        // å¼€å§‹ç›‘å¬æ—¥å¿—æµ
        startLogStream();

        // æ‰“å°é€‰æ‹©çš„ç‰¹å¾åˆ—ä¿¡æ¯
        console.log('GAN 1 ç‰¹å¾åˆ—:', featureColumns1);
        console.log('GAN 2 ç‰¹å¾åˆ—:', featureColumns2);
        console.log('GAN 3 ç‰¹å¾åˆ—:', featureColumns3);
        console.log('ç›®æ ‡åˆ—:', targetColumns);

        // åˆ›å»ºFormDataå¯¹è±¡ç”¨äºå‘é€æ–‡ä»¶
        const formData = new FormData();
        formData.append('train_csv', dataPath);
        formData.append('save_path', ckptDir + '/model.pt');
        formData.append('feature_columns', JSON.stringify([
          featureColumns1,
          featureColumns2,
          featureColumns3
        ]));
        formData.append('target_column', JSON.stringify(targetColumns));
        formData.append('batch_size', batchSize);
        formData.append('num_epochs', numEpochs);
        formData.append('lr', lr);
        formData.append('train_split', trainSplit);
        formData.append('window_sizes', JSON.stringify(windowSizes));
        formData.append('model_config', JSON.stringify(modelConfig));

        // æ·»åŠ æ¨¡å‹æ–‡ä»¶
        modelConfig.models.forEach((model, index) => {
          if (model.type === 'custom' && model.file) {
            formData.append(`model${index + 1}`, model.file);
          }
        });

        // æ‰“å°FormDataå†…å®¹ç”¨äºè°ƒè¯•
        for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }

        const response = await fetch('/train', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'è®­ç»ƒè¯·æ±‚å¤±è´¥');
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        // ä¿å­˜ç‰¹å¾ç»„å’Œç›®æ ‡åˆ—é…ç½®
        saveTrainingConfig([
          featureColumns1,
          featureColumns2,
          featureColumns3
        ], targetColumns);

      } catch (error) {
        console.error('è®­ç»ƒé”™è¯¯:', error);
        alert('è®­ç»ƒå¯åŠ¨å¤±è´¥: ' + error.message);
        // åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºé”™è¯¯
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent += `é”™è¯¯: ${error.message}\n`;
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        startButton.disabled = false;
        startButton.textContent = 'å¼€å§‹è®­ç»ƒæ¨¡å‹';
      }
    }

    async function startPrediction() {
      const inputPath = document.getElementById('predict_input').value;
      const outputPath = document.getElementById('predict_output').value;
      const ckptPath = document.getElementById('predict_ckpt').value;

      // æ£€æŸ¥å¿…è¦å‚æ•°
      if (!inputPath || !outputPath || !ckptPath) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦å‚æ•°ï¼');
        return;
      }

      // ç¦ç”¨å¼€å§‹æŒ‰é’®
      const startButton = document.querySelector('.start-button');
      startButton.disabled = true;
      startButton.textContent = 'é¢„æµ‹ä¸­...';

      try {
        // æ¸…ç©ºæ—¥å¿—è¾“å‡º
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent = 'æ­£åœ¨å¯åŠ¨é¢„æµ‹...\n';
        
        // å¼€å§‹ç›‘å¬æ—¥å¿—æµ
        startLogStream();

        const response = await fetch('/predict', {
          method: 'POST',
          body: JSON.stringify({
            input_path: inputPath,
            output_path: outputPath,
            ckpt_path: ckptPath,
            feature_groups: window.featureGroups || [], // ä½¿ç”¨ä¹‹å‰è®­ç»ƒæ—¶ä¿å­˜çš„ç‰¹å¾ç»„
            target_columns: window.targetColumns || []  // ä½¿ç”¨ä¹‹å‰è®­ç»ƒæ—¶ä¿å­˜çš„ç›®æ ‡åˆ—
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'é¢„æµ‹è¯·æ±‚å¤±è´¥');
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        // æ˜¾ç¤ºé¢„æµ‹ç»“æœåŒºåŸŸ
        const predictionResults = document.getElementById('predictionResults');
        predictionResults.style.display = 'block';

        // åŠ è½½é¢„æµ‹ç»“æœCSVæ–‡ä»¶
        async function loadPredictionResults(outputPath) {
          try {
            const response = await fetch(`/get_prediction_csv?path=${encodeURIComponent(outputPath)}`);
            if (response.ok) {
              const data = await response.json();
              if (data.error) {
                throw new Error(data.error);
              }
              
              // æ›´æ–°è¡¨æ ¼
              const table = document.getElementById('predictionTable');
              const thead = table.querySelector('thead');
              const tbody = table.querySelector('tbody');
              
              // æ¸…ç©ºç°æœ‰å†…å®¹
              thead.innerHTML = '';
              tbody.innerHTML = '';
              
              // æ·»åŠ è¡¨å¤´
              const headerRow = document.createElement('tr');
              data.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);
              
              // æ·»åŠ æ•°æ®è¡Œ
              data.rows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach((cell, index) => {
                  const td = document.createElement('td');
                  // å¦‚æœæ˜¯æ•°å€¼ï¼Œæ·»åŠ é¢œè‰²æ ‡è¯†
                  if (typeof cell === 'number') {
                    td.textContent = cell.toFixed(4);
                    if (cell > 0) {
                      td.classList.add('positive');
                    } else if (cell < 0) {
                      td.classList.add('negative');
                    }
                  } else {
                    td.textContent = cell;
                  }
                  tr.appendChild(td);
                });
                tbody.appendChild(tr);
              });
            }
          } catch (error) {
            console.error('åŠ è½½é¢„æµ‹ç»“æœå¤±è´¥:', error);
            const table = document.getElementById('predictionTable');
            table.innerHTML = `<tr><td>åŠ è½½é¢„æµ‹ç»“æœå¤±è´¥: ${error.message}</td></tr>`;
          }
        }

        // å®šæœŸæ£€æŸ¥å¹¶æ›´æ–°å›¾ç‰‡å’Œè¡¨æ ¼
        const outputDir = outputPath.substring(0, outputPath.lastIndexOf('/'));
        const checkInterval = setInterval(async () => {
          try {
            // åŠ è½½é¢„æµ‹ç»“æœè¡¨æ ¼
            await loadPredictionResults(outputPath);

            const imageResponse = await fetch(`/get_prediction_images?output_dir=${encodeURIComponent(outputDir)}`);
            if (imageResponse.ok) {
              const images = await imageResponse.json();
              
              // æ›´æ–°æ‹Ÿåˆæ›²çº¿å›¾ç‰‡
              if (images.fitting_curves) {
                const fittingCurves = images.fitting_curves;
                for (let i = 0; i < fittingCurves.length; i++) {
                  const imgId = i < 3 ? `g${i+1}TrainFitting` : `g${i-2}TestFitting`;
                  const img = document.getElementById(imgId);
                  if (img) {
                    img.src = `/get_image/${encodeURIComponent(fittingCurves[i])}`;
                    img.style.display = 'block';
                  }
                }
              }

              // å¦‚æœæ‰€æœ‰å›¾ç‰‡éƒ½å·²åŠ è½½ï¼Œåœæ­¢æ£€æŸ¥
              if (Object.keys(images).length > 0) {
                clearInterval(checkInterval);
              }
            }
          } catch (error) {
            console.error('è·å–å›¾ç‰‡å¤±è´¥:', error);
          }
        }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡

      } catch (error) {
        console.error('é¢„æµ‹é”™è¯¯:', error);
        alert('é¢„æµ‹å¯åŠ¨å¤±è´¥: ' + error.message);
        // åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºé”™è¯¯
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent += `é”™è¯¯: ${error.message}\n`;
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        startButton.disabled = false;
        startButton.textContent = 'å¼€å§‹é¢„æµ‹';
      }
    }

    // ä¿å­˜è®­ç»ƒæ—¶çš„ç‰¹å¾ç»„å’Œç›®æ ‡åˆ—ï¼Œä¾›é¢„æµ‹æ—¶ä½¿ç”¨
    function saveTrainingConfig(featureGroups, targetColumns) {
      window.featureGroups = featureGroups;
      window.targetColumns = targetColumns;
    }

    function startLogStream() {
      const logOutput = document.getElementById('logOutput');
      const eventSource = new EventSource('/stream');
      
      eventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data).message;
          // åªæ˜¾ç¤ºéç©ºæ¶ˆæ¯
          if (data && data.trim() !== '') {
            logOutput.textContent += data + "\n";
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logOutput.scrollTop = logOutput.scrollHeight;
          }
        } catch (e) {
          console.error('æ—¥å¿—è§£æå¤±è´¥:', e);
          logOutput.textContent += "[æ—¥å¿—è§£æå¤±è´¥]\n";
        }
      };
      
      eventSource.onerror = function(err) {
        console.error('æ—¥å¿—æµé”™è¯¯:', err);
        logOutput.textContent += "[æ—¥å¿—è¿æ¥ä¸­æ–­]\n";
        eventSource.close();
      };
    }

    // æ·»åŠ æ¨¡å‹ç±»å‹åˆ‡æ¢åŠŸèƒ½
    function toggleModelType(modelNum) {
        const customUpload = document.getElementById(`model${modelNum}Upload`);
        const presetSelect = document.getElementById(`model${modelNum}Preset`);
        const modelType = document.querySelector(`input[name="model${modelNum}Type"]:checked`).value;
        
        if (modelType === 'custom') {
            customUpload.style.display = 'block';
            presetSelect.style.display = 'none';
        } else {
            customUpload.style.display = 'none';
            presetSelect.style.display = 'block';
        }
    }

    async function uploadCustomModels() {
      const formData = new FormData();
      let hasModel = false;
      
      // å¤„ç†æ¯ä¸ªæ¨¡å‹
      for (let i = 1; i <= 3; i++) {
        const modelType = document.querySelector(`input[name="model${i}Type"]:checked`).value;
        
        if (modelType === 'custom') {
          const modelFile = document.getElementById(`customModel${i}`).files[0];
          
          if (modelFile) {
            hasModel = true;
            formData.append(`model${i}`, modelFile);
          }
        } else {
          const presetModel = document.getElementById(`presetModel${i}`).value;
          hasModel = true;
          formData.append(`presetModel${i}`, presetModel);
        }
      }
      
      if (!hasModel) {
        alert('è¯·è‡³å°‘é…ç½®ä¸€ä¸ªæ¨¡å‹ï¼ˆè‡ªå®šä¹‰æˆ–é¢„è®¾ï¼‰');
        return;
      }

      try {
        const response = await fetch('/upload_models', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'æ¨¡å‹ä¸Šä¼ å¤±è´¥');
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        alert('æ¨¡å‹é…ç½®æˆåŠŸï¼');
        // æ›´æ–°æ—¥å¿—
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent += `æ¨¡å‹é…ç½®æˆåŠŸ: ${data.message}\n`;
        
        // ä¿å­˜æ¨¡å‹é…ç½®ä¾›è®­ç»ƒä½¿ç”¨
        window.modelConfig = data.model_config;

      } catch (error) {
        console.error('æ¨¡å‹é…ç½®é”™è¯¯:', error);
        alert('æ¨¡å‹é…ç½®å¤±è´¥: ' + error.message);
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent += `é”™è¯¯: ${error.message}\n`;
      }
    }

    function resetCustomModels() {
      // é‡ç½®æ‰€æœ‰æ¨¡å‹ä¸Šä¼ åŒºåŸŸ
      for (let i = 1; i <= 3; i++) {
        // é‡ç½®æ–‡ä»¶è¾“å…¥
        const fileInput = document.getElementById(`customModel${i}`);
        if (fileInput) {
          fileInput.value = '';
        }
        
        // é‡ç½®é¢„è®¾æ¨¡å‹é€‰æ‹©
        const presetSelect = document.getElementById(`presetModel${i}`);
        if (presetSelect) {
          presetSelect.value = 'gru';
        }
        
        // é‡ç½®å•é€‰æŒ‰é’®
        const customRadio = document.querySelector(`input[name="model${i}Type"][value="custom"]`);
        if (customRadio) {
          customRadio.checked = true;
        }
        
        // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
        const customUpload = document.getElementById(`model${i}Upload`);
        const presetSelectDiv = document.getElementById(`model${i}Preset`);
        if (customUpload) {
          customUpload.style.display = 'block';
        }
        if (presetSelectDiv) {
          presetSelectDiv.style.display = 'none';
        }
        
        // é‡ç½®æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        const uploadArea = document.querySelector(`#model${i}Upload .file-upload-area`);
        if (uploadArea) {
          const fileInfo = uploadArea.querySelector('.file-info');
          const placeholder = uploadArea.querySelector('.upload-placeholder');
          const structureInfo = uploadArea.querySelector('.model-structure-info');
          
          if (fileInfo) {
            fileInfo.classList.remove('show');
          }
          if (placeholder) {
            placeholder.style.display = 'flex';
          }
          if (structureInfo) {
            structureInfo.classList.remove('show');
            structureInfo.innerHTML = '';
          }
          uploadArea.classList.remove('has-file');
        }
      }
      
      // æ¸…é™¤ä¿å­˜çš„æ¨¡å‹é…ç½®
      window.modelConfig = null;
      
      // æ›´æ–°æ—¥å¿—
      const logOutput = document.getElementById('logOutput');
      logOutput.textContent += 'æ¨¡å‹é…ç½®å·²é‡ç½®\n';
    }

    // ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
    async function handleFileUpload(input, modelNum) {
        const file = input.files[0];
        if (!file) {
            console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
            return;
        }

        console.log(`å¼€å§‹å¤„ç†æ¨¡å‹ ${modelNum} çš„æ–‡ä»¶ä¸Šä¼ :`, file.name);

        const uploadArea = input.closest('.file-upload-area');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const fileInfo = uploadArea.querySelector('.file-info') || createFileInfoElement(uploadArea);
        const structureInfo = uploadArea.querySelector('.model-structure-info') || createStructureInfoElement(uploadArea);
        const loadingIndicator = uploadArea.querySelector('.structure-loading') || createLoadingIndicator(uploadArea);
        
        try {
            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
            fileInfo.querySelector('.file-name span').textContent = file.name;
            fileInfo.classList.add('show');
            placeholder.style.display = 'none';
            uploadArea.classList.add('has-file');
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            loadingIndicator.classList.add('show');
            structureInfo.classList.remove('show');
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('model_file', file);
            
            console.log('å‘é€æ–‡ä»¶åˆ°æœåŠ¡å™¨è¿›è¡Œåˆ†æ...');
            
            // å‘é€æ–‡ä»¶åˆ°æœåŠ¡å™¨è¿›è¡Œç»“æ„åˆ†æ
            const response = await fetch('/analyze_model', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'æ¨¡å‹ç»“æ„åˆ†æå¤±è´¥');
            }
            
            const data = await response.json();
            console.log('æ”¶åˆ°æœåŠ¡å™¨å“åº”:', data);
            
            // æ˜¾ç¤ºæ¨¡å‹ç»“æ„ä¿¡æ¯
            structureInfo.innerHTML = `
                <strong>æ¨¡å‹ç»“æ„åˆ†æç»“æœï¼š</strong><br>
                <pre>${data.structure}</pre>
            `;
            structureInfo.classList.add('show');
            
            // æ›´æ–°æ—¥å¿—
            const logOutput = document.getElementById('logOutput');
            logOutput.textContent += `æ¨¡å‹ ${modelNum} ç»“æ„åˆ†æå®Œæˆ\n`;
            
        } catch (error) {
            console.error('æ¨¡å‹åˆ†æé”™è¯¯:', error);
            structureInfo.innerHTML = `<span style="color: #e74c3c;">æ¨¡å‹ç»“æ„åˆ†æå¤±è´¥: ${error.message}</span>`;
            structureInfo.classList.add('show');
            
            // æ›´æ–°æ—¥å¿—
            const logOutput = document.getElementById('logOutput');
            logOutput.textContent += `æ¨¡å‹ ${modelNum} åˆ†æå¤±è´¥: ${error.message}\n`;
        } finally {
            loadingIndicator.classList.remove('show');
        }
    }

    // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
    function createFileInfoElement(uploadArea) {
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.innerHTML = `
            <div class="file-name">
                <i class="file-icon">ğŸ“„</i>
                <span></span>
            </div>
            <div class="remove-file" onclick="removeFile(this, ${uploadArea.dataset.modelNum})">
                <i class="remove-icon">âœ•</i>
            </div>
        `;
        uploadArea.appendChild(fileInfo);
        return fileInfo;
    }

    // åˆ›å»ºæ¨¡å‹ç»“æ„ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
    function createStructureInfoElement(uploadArea) {
        const structureInfo = document.createElement('div');
        structureInfo.className = 'model-structure-info';
        uploadArea.appendChild(structureInfo);
        return structureInfo;
    }

    // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
    function createLoadingIndicator(uploadArea) {
        const loading = document.createElement('div');
        loading.className = 'structure-loading';
        loading.innerHTML = '<i class="loading-icon">â³</i> æ­£åœ¨åˆ†ææ¨¡å‹ç»“æ„...';
        uploadArea.appendChild(loading);
        return loading;
    }

    // ä¿®æ”¹ç§»é™¤æ–‡ä»¶å‡½æ•°
    function removeFile(button, modelNum) {
        const fileInfo = button.closest('.file-info');
        const uploadArea = fileInfo.closest('.file-upload-area');
        const input = uploadArea.querySelector('input[type="file"]');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const structureInfo = uploadArea.querySelector('.model-structure-info');
        const loadingIndicator = uploadArea.querySelector('.structure-loading');
        
        // æ¸…é™¤æ–‡ä»¶
        input.value = '';
        fileInfo.classList.remove('show');
        placeholder.style.display = 'flex';
        uploadArea.classList.remove('has-file');
        
        // æ¸…é™¤ç»“æ„ä¿¡æ¯
        if (structureInfo) {
            structureInfo.classList.remove('show');
            structureInfo.innerHTML = '';
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        if (loadingIndicator) {
            loadingIndicator.classList.remove('show');
        }
        
        // æ›´æ–°æ—¥å¿—
        const logOutput = document.getElementById('logOutput');
        logOutput.textContent += `æ¨¡å‹ ${modelNum} æ–‡ä»¶å·²ç§»é™¤\n`;
    }

    // ä¸ºæ¯ä¸ªæ–‡ä»¶è¾“å…¥æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.model-file-input').forEach((input, index) => {
        const modelNum = index + 1;
        input.closest('.file-upload-area').dataset.modelNum = modelNum;
        input.addEventListener('change', () => handleFileUpload(input, modelNum));
    });

    // åœ¨é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // ç»‘å®šå¼€å§‹è®­ç»ƒæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
      const startTrainingButton = document.getElementById('startTrainingButton');
      if (startTrainingButton) {
        startTrainingButton.addEventListener('click', startTraining);
      }
    });
  </script>
</body>
</html>